/*
Deployment script for Potch_Huis

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "Potch_Huis"
:setvar DefaultFilePrefix "Potch_Huis"
:setvar DefaultDataPath "C:\Users\Admin\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\"
:setvar DefaultLogPath "C:\Users\Admin\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Rename refactoring operation with key 74e83254-2b31-467c-b66f-a7ae1ce4a803 is skipped, element [dbo].[Donation].[Description] (SqlSimpleColumn) will not be renamed to DonationNumber';


GO
PRINT N'Rename refactoring operation with key aae4b304-f867-42c7-b165-b80b986b095c is skipped, element [dbo].[Donation].[Purpose] (SqlSimpleColumn) will not be renamed to Received';


GO
PRINT N'Creating Table [dbo].[Donation]...';


GO
CREATE TABLE [dbo].[Donation] (
    [Id]             INT            IDENTITY (1, 1) NOT NULL,
    [Type]           NVARCHAR (MAX) NOT NULL,
    [Amount]         NVARCHAR (MAX) NOT NULL,
    [DonationNumber] NVARCHAR (MAX) NOT NULL,
    [Received]       NVARCHAR (MAX) NOT NULL,
    [MemberNumber]   NVARCHAR (50)  NOT NULL,
    [ConfirmedBy]    NVARCHAR (MAX) NOT NULL,
    [Confirmed]      NVARCHAR (MAX) NOT NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Procedure [dbo].[spDonation_Delete]...';


GO
CREATE PROCEDURE [dbo].[spDonation_Delete]
	@DonationNumber nvarchar(50)
AS
BEGIN
	DELETE FROM dbo.Donation WHERE DonationNumber = @DonationNumber;
END
GO
PRINT N'Creating Procedure [dbo].[spDonation_Get]...';


GO
CREATE PROCEDURE [dbo].[spDonation_Get]
	@DonationNumber nvarchar(50)
AS
BEGIN
	SELECT * FROM dbo.Donation WITH(NOLOCK) 
	WHERE DonationNumber = @DonationNumber;
END
GO
PRINT N'Creating Procedure [dbo].[spDonation_Get_Member]...';


GO
CREATE PROCEDURE [dbo].[spDonation_Get_Member]
	@MemberNumber nvarchar(50)
AS
BEGIN
	SELECT * FROM dbo.Donation WITH(NOLOCK) 
	WHERE MemberNumber = @MemberNumber;
END
GO
PRINT N'Creating Procedure [dbo].[spDonation_GetAll_Confirmed]...';


GO
CREATE PROCEDURE [dbo].[spDonation_GetAll_Confirmed]
    @PageNumber INT,
    @PageSize INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        ROW_NUMBER() OVER (ORDER BY Confirmed DESC) AS Id, [Type], Amount, MemberNumber, DonationNumber, CONVERT(varchar(10), Received, 103) AS Received, CONVERT(varchar(10), Confirmed, 103) AS Confirmed, ConfirmedBy
    FROM 
        dbo.Donation WITH (NOLOCK)
    WHERE 
        Confirmed != '01/01/2000' AND 
        Confirmed <= GETDATE()
    ORDER BY 
        Confirmed DESC
    OFFSET (@PageNumber - 1) * @PageSize ROWS
    FETCH NEXT @PageSize ROWS ONLY;

END
GO
PRINT N'Creating Procedure [dbo].[spDonation_GetAll_Unconfirmed]...';


GO
CREATE PROCEDURE [dbo].[spDonation_GetAll_Unconfirmed]
    @PageNumber INT,
    @PageSize INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        ROW_NUMBER() OVER (ORDER BY Received ASC) AS Id, [Type], Amount, MemberNumber, DonationNumber, CONVERT(varchar(10), Received, 103) AS Received, CONVERT(varchar(10), Confirmed, 103) AS Confirmed, ConfirmedBy
    FROM 
        dbo.Donation WITH (NOLOCK)
    WHERE 
        Confirmed = '01/01/2000'
    ORDER BY 
        Confirmed ASC
    OFFSET (@PageNumber - 1) * @PageSize ROWS
    FETCH NEXT @PageSize ROWS ONLY;

END
GO
PRINT N'Creating Procedure [dbo].[spDonation_Insert]...';


GO
CREATE PROCEDURE [dbo].[spDonation_Insert]
    @Type NVARCHAR(MAX),
    @Amount NVARCHAR(MAX),
    @DonationNumber NVARCHAR(MAX),
    @Received NVARCHAR(MAX),
    @MemberNumber NVARCHAR(50),
    @ConfirmedBy NVARCHAR(MAX),
    @Confirmed NVARCHAR(MAX),
    @Id INT = 0
AS
BEGIN
	INSERT INTO dbo.Donation (Type, Amount, DonationNumber, Received, MemberNumber, ConfirmedBy, Confirmed)
    VALUES (@Type, @Amount, @DonationNumber, @Received, @MemberNumber, @ConfirmedBy, @Confirmed);
END
GO
PRINT N'Creating Procedure [dbo].[spDonation_Update]...';


GO
CREATE PROCEDURE [dbo].[spDonation_Update]
    @Type NVARCHAR(MAX),
    @Amount NVARCHAR(MAX),
    @DonationNumber NVARCHAR(MAX),
    @Received NVARCHAR(MAX),
    @MemberNumber NVARCHAR(50),
    @ConfirmedBy NVARCHAR(MAX),
    @Confirmed NVARCHAR(MAX),
    @Id INT = 0
AS
BEGIN
    UPDATE dbo.Donation
    SET Type = @Type, Amount = @Amount, DonationNumber = @DonationNumber, Received = @Received,
        MemberNumber = @MemberNumber, ConfirmedBy = @ConfirmedBy, Confirmed = @Confirmed
END
GO
-- Refactoring step to update target server with deployed transaction logs
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '74e83254-2b31-467c-b66f-a7ae1ce4a803')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('74e83254-2b31-467c-b66f-a7ae1ce4a803')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'aae4b304-f867-42c7-b165-b80b986b095c')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('aae4b304-f867-42c7-b165-b80b986b095c')

GO

GO
if not exists(select 1 from dbo.Member)
begin 
	insert into dbo.Member (Firstname, Lastname, Email, Cellphone, StreetAddress,Suburb, City, MemberNumber)
	values ('Austin', 'van der Merwe', 'aus.vd.merwe@gmail.com', '0796234424', '1 Ingonya Street', 'Baillie Park', 'Potchefstroom', 'PH00001ADM')
end
GO

GO
PRINT N'Update complete.';


GO
